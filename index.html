<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Timetable & Event Reminder</title>
    <style>
        /* --- style.css content starts here --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0; /* Remove default body padding to allow header/footer to span full width */
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
            display: flex; /* Use flexbox for overall layout */
            flex-direction: column; /* Stack header, main content, footer vertically */
            min-height: 100vh; /* Ensure body takes at least full viewport height */
        }

        /* Header Styles */
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .header .logo {
            font-size: 1.8em;
            font-weight: bold;
            text-decoration: none;
            color: white;
        }

        .header .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .header .nav-link:hover {
            background-color: #34495e;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto; /* Center the main content area */
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
            width: calc(100% - 40px); /* Account for body padding if it were present, or ensure it fits */
            box-sizing: border-box;
        }

        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
        }

        /* View Switcher */
        .view-switcher {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }

        .view-switcher button {
            padding: 12px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            background-color: #e0e0e0;
            color: #555;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .view-switcher button:hover {
            background-color: #d0d0d0;
            transform: translateY(-2px);
        }

        .view-switcher button.active {
            background-color: #3498db;
            color: white;
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        /* Filters */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #e8f0fe;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease-in-out;
        }

        .filters.hidden {
            display: none;
            opacity: 0;
            height: 0;
            overflow: hidden;
            padding: 0 20px; /* Adjust padding for hidden state */
            margin-bottom: 0; /* Adjust margin for hidden state */
        }

        .filters.visible {
            display: flex; /* Or block, grid, etc., depending on final layout */
            opacity: 1;
            height: auto; /* Allow content to dictate height */
            padding: 20px;
            margin-bottom: 30px;
        }


        .filters label {
            font-weight: bold;
            color: #34495e;
        }

        .filters select,
        .filters input[type="text"],
        .filters input[type="date"] {
            padding: 10px 12px;
            border: 1px solid #cce7ff;
            border-radius: 5px;
            font-size: 1rem;
            color: #555;
            background-color: #f8faff;
            transition: border-color 0.3s ease;
        }

        .filters select:focus,
        .filters input[type="text"]:focus,
        .filters input[type="date"]:focus {
            border-color: #6daff7;
            outline: none;
            box-shadow: 0 0 0 3px rgba(109, 175, 247, 0.2);
        }

        /* Loader Styles */
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            margin: 50px auto;
            display: none; /* Hidden by default */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader.show {
            display: block;
        }

        /* Content Sections */
        .content-section {
            transition: all 0.5s ease-in-out;
            padding-top: 20px; /* Give some space when visible */
        }

        .content-section.hidden {
            display: none;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            padding-top: 0;
        }

        .content-section.visible {
            display: block;
            opacity: 1;
            height: auto; /* Ensure it takes necessary height */
        }


        /* Timetable Grid - Now a Table */
        #timetable-grid {
            margin-bottom: 40px;
            padding: 20px;
            background-color: #f7fcfb;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow-x: auto; /* Enable horizontal scrolling on small screens */
        }

        #timetable-grid table {
            width: 100%;
            border-collapse: collapse;
            /* min-width: 700px; Removed for better mobile responsiveness */
        }

        #timetable-grid th,
        #timetable-grid td {
            border: 1px solid #e0e0e0;
            padding: 12px 8px;
            text-align: center;
            vertical-align: top;
            min-width: 100px; /* Minimum width for cells on larger screens */
        }

        #timetable-grid th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
            padding: 15px 8px;
        }

        #timetable-grid td {
            background-color: #ffffff;
            font-size: 0.9em;
            color: #555;
            height: 80px; /* Fixed height for time slots */
        }

        #timetable-grid td:first-child { /* Time column */
            background-color: #e8f0fe;
            font-weight: bold;
            color: #2c3e50;
            min-width: 90px; /* Keep time column a bit wider on larger screens */
        }

        .table-class-cell {
            background-color: #e0f2f7; /* Light blue for class cells */
            border-left: 4px solid #2196f3; /* Blue accent */
            border-radius: 5px;
            padding: 8px;
            margin: 2px; /* Small margin around the class block */
            height: 100%; /* Fill available space */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: transform 0.1s ease;
            cursor: pointer; /* Indicate clickability */
        }

        .table-class-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .table-class-cell strong {
            display: block;
            font-size: 1em;
            color: #0d47a1;
            margin-bottom: 3px;
        }

        /* Tooltip/Popup Styles */
        .class-details-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .class-details-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .class-details-popup {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            max-width: 400px;
            width: 90%;
            text-align: left;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .class-details-popup-overlay.show .class-details-popup {
            transform: scale(1);
        }

        .class-details-popup h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .class-details-popup p {
            margin: 8px 0;
            color: #555;
            font-size: 1.05em;
        }

        .class-details-popup p strong {
            color: #34495e;
            display: inline-block;
            min-width: 80px;
        }

        .class-details-popup .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #888;
            background: none;
            border: none;
            line-height: 1;
            padding: 5px;
            transition: color 0.2s ease;
        }

        .class-details-popup .close-btn:hover {
            color: #333;
        }

        /* Events List */
        #events-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
            background-color: #fdfdfd;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .event-card {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Pushes time-left to bottom */
        }

        .event-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .event-card.assignment { border-left: 5px solid #ff9800; } /* Orange */
        .event-card.exam { border-left: 5px solid #f44336; }      /* Red */
        .event-card.notice { border-left: 5px solid #4caf50; }    /* Green */
        .event-card.holiday { border-left: 5px solid #9c27b0; }    /* Purple */
        /* Add more colors for different event types */

        .event-card h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            font-size: 1.3em;
        }

        .event-card p {
            margin: 5px 0;
            font-size: 1em;
            color: #555;
        }

        .event-card .type {
            font-weight: bold;
            color: #666;
            text-transform: uppercase;
            font-size: 0.85em;
            margin-bottom: 8px;
        }

        .event-card .date-time { /* Combined date and time display */
            font-weight: bold;
            color: #1a73e8;
            margin-top: 5px;
        }

        .event-card .time-left {
            font-size: 1.1em;
            font-weight: bold;
            color: #d32f2f; /* Red for urgent */
            margin-top: auto; /* Push to bottom */
            padding-top: 10px;
            border-top: 1px solid #eee;
            text-align: right;
        }

        .event-card .time-left.soon {
            color: #fb8c00; /* Orange for soon */
        }

        .event-card .time-left.overdue {
            color: #b71c1c; /* Darker red for overdue */
            font-style: italic;
        }

        /* Highlight for scrolled-to event */
        .highlight-card {
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.5), 0 4px 12px rgba(0, 0, 0, 0.12); /* Blue glow */
            animation: pulse-highlight 1.5s ease-out;
        }

        @keyframes pulse-highlight {
            0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.5), 0 4px 12px rgba(0, 0, 0, 0.12); }
            50% { box-shadow: 0 0 0 8px rgba(52, 152, 219, 0.8), 0 4px 12px rgba(0, 0, 0, 0.12); }
            100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.5), 0 4px 12px rgba(0, 0, 0, 0.12); }
        }


        .no-events-message {
            text-align: center;
            grid-column: 1 / -1; /* Span across all columns in the grid */
            padding: 30px;
            font-size: 1.2em;
            color: #777;
            background-color: #f0f0f0;
            border-radius: 8px;
            margin-top: 20px;
        }

        /* Admin Form Styles - Included for completeness but not used in this single file */
        .event-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 600px;
            margin: 30px auto;
            padding: 30px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .event-form label {
            font-weight: bold;
            color: #34495e;
            margin-bottom: 5px;
        }

        .event-form input[type="text"],
        .event-form input[type="date"],
        .event-form select,
        .event-form textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            color: #555;
            background-color: #fff;
            width: 100%;
            box-sizing: border-box; /* Include padding in element's total width and height */
        }

        .event-form input[type="text"]:focus,
        .event-form input[type="date"]:focus,
        .event-form select:focus,
        .event-form textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .event-form button {
            padding: 12px 25px;
            background-color: #28a745; /* Green for add button */
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 15px;
        }

        .event-form button:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Footer Styles */
        .footer {
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            flex-shrink: 0;
        }

        .footer p {
            margin: 0;
            font-size: 0.9em;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 10px;
            }
            .header .logo {
                margin-bottom: 10px;
            }
            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .view-switcher button {
                flex: 1; /* Make buttons take equal width */
            }

            #timetable-grid table {
                min-width: unset; /* Allow table to shrink on small screens */
            }
            #timetable-grid th,
            #timetable-grid td {
                min-width: unset; /* Allow cells to shrink */
                padding: 8px 4px; /* Reduced padding */
            }
            #timetable-grid td:first-child {
                min-width: 60px; /* Keep time column a bit wider */
            }
            .table-class-cell {
                padding: 5px; /* Reduced padding for class cells */
            }
            .table-class-cell strong {
                font-size: 0.9em;
            }
            .table-class-cell span {
                /* Removed this for smaller screens when only subject is shown */
                display: none;
            }
            .container {
                padding: 15px; /* Adjust padding for smaller screens */
                width: calc(100% - 30px); /* Adjust width based on new padding */
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="index.html" class="logo">Timetable & Events</a>
        <nav>
            <a href="admin.html" class="nav-link">Admin Panel</a>
        </nav>
    </header>

    <div class="container">
        <h1>Class Timetable & Event Reminder</h1>

        <div class="view-switcher">
            <button id="showTimetableBtn" class="active">Show Timetable</button>
            <button id="showEventsBtn">Show Events</button>
        </div>

        <div id="filters" class="filters hidden">
            <label for="eventType">Filter by Type:</label>
            <select id="eventType">
                <option value="">All</option>
                <option value="Assignment">Assignment</option>
                <option value="Exam">Exam</option>
                <option value="Notice">Notice</option>
                <option value="Holiday">Holiday</option>
                </select>

            <label for="eventSubject">Filter by Subject:</label>
            <input type="text" id="eventSubject" placeholder="Enter subject...">

            <label for="eventTitleFilter">Filter by Title:</label>
            <input type="text" id="eventTitleFilter" placeholder="Enter title...">

            <label for="eventDate">Filter by Date:</label>
            <input type="date" id="eventDate">
        </div>

        <div id="loader" class="loader show"></div> <div id="timetable-section" class="content-section">
            <h2>Weekly Timetable</h2>
            <div id="timetable-grid">
                </div>
        </div>

        <div id="events-section" class="content-section hidden">
            <h2>Upcoming Events</h2>
            <div id="events-list">
                </div>
        </div>
    </div>

    <div id="classDetailsPopupOverlay" class="class-details-popup-overlay">
        <div class="class-details-popup">
            <button class="close-btn">&times;</button>
            <h3 id="popupSubject"></h3>
            <p><strong>Teacher:</strong> <span id="popupTeacher"></span></p>
            <p><strong>Room:</strong> <span id="popupRoom"></span></p>
            <p><strong>Time:</strong> <span id="popupTime"></span></p>
            <p id="popupEffectiveUntil" style="font-style: italic; font-size: 0.9em; color: #777;"></p> <!-- New line for effective date -->
        </div>
    </div>
    <footer class="footer">
        <div class='onesignal-customlink-container'></div>
        <p>&copy; 2025 Class Timetable & Event Reminder. All rights reserved.</p>
    </footer>

    <script>
        /* --- script.js content starts here --- */
        document.addEventListener('DOMContentLoaded', async () => {
            // IMPORTANT: This URL is provided by the user.
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbztJs-3nqRRaxzJG-Buw2CbY5Gqm2_hj_xDf5xhUQ2ebrV2eANFVUzfXHehQEiQ_wZAGQ/exec';
            // IMPORTANT: This SECRET_KEY MUST match the one in your Google Apps Script (Code.gs)
            const SECRET_KEY = 'your_secret_key_here'; // <--- CHANGE THIS!

            const loader = document.getElementById('loader');
            const showTimetableBtn = document.getElementById('showTimetableBtn');
            const showEventsBtn = document.getElementById('showEventsBtn');
            const timetableSection = document.getElementById('timetable-section');
            const eventsSection = document.getElementById('events-section');
            const filters = document.getElementById('filters');

            const timetableGrid = document.getElementById('timetable-grid');
            const eventsList = document.getElementById('events-list');
            const eventTypeFilter = document.getElementById('eventType');
            const eventSubjectFilter = document.getElementById('eventSubject');
            const eventTitleFilter = document.getElementById('eventTitleFilter'); // New filter element
            const eventDateFilter = document.getElementById('eventDate');

            const classDetailsPopupOverlay = document.getElementById('classDetailsPopupOverlay');
            const popupSubject = document.getElementById('popupSubject');
            const popupTeacher = document.getElementById('popupTeacher');
            const popupRoom = document.getElementById('popupRoom');
            const popupTime = document.getElementById('popupTime');
            const popupEffectiveUntil = document.getElementById('popupEffectiveUntil'); // New element
            const popupCloseBtn = classDetailsPopupOverlay.querySelector('.close-btn');

            let allEvents = []; // Global array to store all fetched events
            const activeCountdowns = {}; // Store countdown intervals by event ID

            const showLoader = () => loader.classList.add('show');
            const hideLoader = () => loader.classList.remove('show');

            const fetchData = async (sheetName) => {
                try {
                    // Include secretKey and a dummy token for GET requests to satisfy authentication in Apps Script
                    const url = new URL(WEB_APP_URL);
                    url.searchParams.append('sheet', sheetName);
                    url.searchParams.append('secretKey', SECRET_KEY);
                    url.searchParams.append('token', 'dummy_token_for_public_read'); // A dummy token for public read
                                                                                     // Apps Script will check if it's 'valid'
                                                                                     // We could make doGet not require a token for public data,
                                                                                     // but for now, this keeps it consistent with doPost auth.

                    const response = await fetch(url.toString());
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error(`Error fetching ${sheetName} data:`, error);
                    return []; // Return empty array on error
                }
            };

            const showSection = (sectionId) => {
                const sections = [timetableSection, eventsSection];
                sections.forEach(section => {
                    if (section.id === sectionId) {
                        section.classList.remove('hidden');
                        section.classList.add('visible');
                    } else {
                        section.classList.add('hidden');
                        section.classList.remove('visible');
                    }
                });

                // Toggle filters visibility based on active section
                if (sectionId === 'events-section') {
                    filters.classList.remove('hidden');
                    filters.classList.add('visible');
                } else {
                    filters.classList.add('hidden');
                    filters.classList.remove('visible');
                }

                // Update active button state
                showTimetableBtn.classList.remove('active');
                showEventsBtn.classList.remove('active');
                if (sectionId === 'timetable-section') {
                    showTimetableBtn.classList.add('active');
                } else {
                    showEventsBtn.classList.add('active');
                }
            };

            // Helper function to format time strings (e.g., "8:15 AM", "14:30")
            const formatTime = (timeValue) => {
                try {
                    let dateObj;

                    if (timeValue instanceof Date) {
                        dateObj = timeValue;
                    } else if (typeof timeValue === 'string') {
                        // Attempt to parse as a standard time string ("09:00 AM", "14:30")
                        dateObj = new Date(`2000/01/01 ${timeValue}`);

                        // If direct parsing failed OR it resulted in an 1899 epoch date (common for Sheets' time values),
                        // AND it looks like an ISO string, try to extract the time part from the ISO string.
                        if (isNaN(dateObj.getTime()) || (dateObj.getFullYear() < 1970 && String(timeValue).includes('T') && String(timeValue).includes('Z'))) {
                            const timePartMatch = String(timeValue).match(/T(\d{2}:\d{2}:\d{2})/); // Extract HH:MM:SS
                            if (timePartMatch && timePartMatch[1]) {
                                dateObj = new Date(`2000/01/01 ${timePartMatch[1]}`);
                            } else {
                                // Fallback: if it's an ISO string but the above didn't work,
                                // try parsing the original ISO string as a Date object.
                                dateObj = new Date(timeValue);
                            }
                        }
                    }

                    if (isNaN(dateObj.getTime())) {
                        console.warn("Frontend formatTime: Could not reliably parse time value, returning original:", timeValue);
                        return String(timeValue); // Fallback to original string
                    }

                    // Use toLocaleTimeString for robust, locale-aware time formatting
                    return dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

                } catch (e) {
                    console.warn("Frontend formatTime: Error during formatting, returning original:", timeValue, e);
                    return String(timeValue); // Fallback to original string on error
                }
            };


            const renderTimetable = (timetableData) => {
                timetableGrid.innerHTML = ''; // Clear previous content

                if (timetableData.length === 0) {
                    timetableGrid.innerHTML = '<p class="no-events-message">No timetable data available.</p>';
                    return;
                }

                const dayOrder = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
                const uniqueTimeSlots = new Set();
                const classesByTimeAndDay = {}; // Structure: { "HH:MM": { "Day": [class1, class2], ... }, ... }

                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize today's date to start of day for comparison

                // Filter timetable data based on EffectiveUntilDate
                const filteredTimetableData = timetableData.filter(item => {
                    if (item.EffectiveUntilDate) {
                        const effectiveDate = new Date(item.EffectiveUntilDate);
                        effectiveDate.setHours(0, 0, 0, 0); // Normalize effective date to start of day
                        return effectiveDate >= today; // Only include if effective date is today or in the future
                    }
                    return true; // If no EffectiveUntilDate, it's a permanent entry, so include it
                });


                filteredTimetableData.forEach(item => {
                    if (item.StartTime) {
                        const formattedStartTime = formatTime(item.StartTime);
                        uniqueTimeSlots.add(formattedStartTime);
                    }
                    if (item.StartTime && item.Day && dayOrder.includes(item.Day)) {
                        const formattedStartTime = formatTime(item.StartTime);
                        if (!classesByTimeAndDay[formattedStartTime]) {
                            classesByTimeAndDay[formattedStartTime] = {};
                        }
                        if (!classesByTimeAndDay[formattedStartTime][item.Day]) {
                            classesByTimeAndDay[formattedStartTime][item.Day] = [];
                        }
                        classesByTimeAndDay[formattedStartTime][item.Day].push(item);
                    }
                });

                const sortedTimeSlots = Array.from(uniqueTimeSlots).sort((a, b) => {
                    const timeA = new Date(`2000/01/01 ${a}`);
                    const timeB = new Date(`2000/01/01 ${b}`);
                    return timeA - timeB;
                });

                const table = document.createElement('table');
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');

                const headerRow = document.createElement('tr');
                headerRow.innerHTML = '<th>Time</th>';
                dayOrder.forEach(day => {
                    headerRow.innerHTML += `<th>${day}</th>`;
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                sortedTimeSlots.forEach(timeSlot => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${timeSlot}</td>`;

                    dayOrder.forEach(day => {
                        const cell = document.createElement('td');
                        const classesInSlot = classesByTimeAndDay[timeSlot] && classesByTimeAndDay[timeSlot][day] ? classesByTimeAndDay[timeSlot][day] : [];

                        if (classesInSlot.length > 0) {
                            classesInSlot.forEach(classItem => {
                                const classDiv = document.createElement('div');
                                classDiv.className = 'table-class-cell';
                                classDiv.dataset.subject = classItem.Subject;
                                classDiv.dataset.teacher = classItem.Teacher;
                                classDiv.dataset.room = classItem.Room;
                                classDiv.dataset.startTime = formatTime(classItem.StartTime);
                                classDiv.dataset.endTime = formatTime(classItem.EndTime);
                                classDiv.dataset.effectiveUntilDate = classItem.EffectiveUntilDate || ''; // Store new field

                                classDiv.innerHTML = `<strong>${classItem.Subject}</strong>`;
                                cell.appendChild(classDiv);
                            });
                        } else {
                            cell.innerHTML = '';
                        }
                        row.appendChild(cell);
                    });
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
                timetableGrid.appendChild(table);

                if (filteredTimetableData.length > 0 && table.innerHTML === '<thead><tr><th>Time</th><th>Monday</th><th>Tuesday</th><th>Wednesday</th><th>Thursday</th><th>Friday</th><th>Saturday</th><th>Sunday</th></tr></thead><tbody></tbody>') {
                     timetableGrid.innerHTML = '<p class="no-events-message">Timetable data found, but no valid classes were rendered. Ensure "Day", "StartTime", and "EndTime" columns are correctly populated.</p>';
                } else if (filteredTimetableData.length === 0 && timetableData.length > 0) {
                     timetableGrid.innerHTML = '<p class="no-events-message">All timetable entries have expired or are not effective yet.</p>';
                }
            };

            // Clears all active countdown intervals
            const clearAllCountdowns = () => {
                for (const eventId in activeCountdowns) {
                    clearInterval(activeCountdowns[eventId]);
                    delete activeCountdowns[eventId];
                }
            };

            // Function to update a single event's countdown
            const updateCountdown = (event, countdownElement) => {
                const eventDateTime = new Date(`${event.Date} ${event.Time}`);
                const now = new Date();
                const diff = eventDateTime.getTime() - now.getTime();

                if (diff < 0) {
                    countdownElement.textContent = "OVERDUE";
                    countdownElement.className = 'time-left overdue';
                    clearInterval(activeCountdowns[event.ID]);
                    delete activeCountdowns[event.ID];
                    return;
                }

                const seconds = Math.floor((diff / 1000) % 60);
                const minutes = Math.floor((diff / (1000 * 60)) % 60);
                const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
                const days = Math.floor((diff / (1000 * 60 * 60 * 24)));

                let countdownText = "";
                let countdownClass = "time-left";

                if (days > 0) {
                    countdownText = `${days} day${days > 1 ? 's' : ''} left`;
                    if (days <= 7) countdownClass += " soon";
                } else if (hours > 0) {
                    countdownText = `${hours}h ${minutes}m ${seconds}s left`;
                    countdownClass += " soon";
                } else if (minutes > 0) {
                    countdownText = `${minutes}m ${seconds}s left`;
                    countdownClass += " soon";
                } else {
                    countdownText = `${seconds}s left`;
                    countdownClass += " soon";
                }

                countdownElement.textContent = countdownText;
                countdownElement.className = countdownClass;
            };


            const renderEvents = (eventsToRender) => {
                clearAllCountdowns();
                eventsList.innerHTML = '';

                const now = new Date();
                let activeEvents = eventsToRender.filter(event => {
                    const eventDateTime = new Date(`${event.Date} ${event.Time}`);
                    return eventDateTime >= now;
                });

                if (activeEvents.length === 0) {
                    eventsList.innerHTML = '<p class="no-events-message">No upcoming events found matching your criteria.</p>';
                    return;
                }

                activeEvents.sort((a, b) => {
                    const dateTimeA = new Date(`${a.Date} ${a.Time}`);
                    const dateTimeB = new Date(`${b.Date} ${b.Time}`);
                    return dateTimeA - dateTimeB;
                });

                activeEvents.forEach(event => {
                    const card = document.createElement('div');
                    card.className = `event-card ${event.Type.toLowerCase().replace(/\s/g, '-')}`;
                    card.id = `event-${event.ID}`; // Set ID for deep linking

                    const formattedDate = event.Date ? new Date(event.Date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : 'N/A';
                    const formattedTime = event.Time || 'N/A';

                    card.innerHTML = `
                        <p class="type">${event.Type}</p>
                        <h3>${event.Title}</h3>
                        <p><strong>Subject:</strong> ${event.Subject}</p>
                        <p class="date-time"><strong>Date:</strong> ${formattedDate} <strong>Time:</strong> ${formattedTime}</p>
                        <p><strong>Details:</strong> ${event.Details}</p>
                        <div class="time-left" id="countdown-${event.ID}"></div>
                    `;
                    eventsList.appendChild(card);

                    const countdownElement = document.getElementById(`countdown-${event.ID}`);
                    if (countdownElement) {
                        updateCountdown(event, countdownElement);

                        const eventDateTime = new Date(`${event.Date} ${event.Time}`);
                        const diffMs = eventDateTime.getTime() - now.getTime();
                        if (diffMs > 0 && diffMs <= (24 * 60 * 60 * 1000) + (5 * 60 * 1000)) {
                            activeCountdowns[event.ID] = setInterval(() => {
                                updateCountdown(event, countdownElement);
                            }, 1000);
                        }
                    }
                });
            };

            const applyFilters = () => {
                let filteredEvents = [...allEvents];

                const type = eventTypeFilter.value.toLowerCase();
                const subject = eventSubjectFilter.value.toLowerCase().trim();
                const title = eventTitleFilter.value.toLowerCase().trim(); // Get title filter value
                const date = eventDateFilter.value;

                if (type) {
                    filteredEvents = filteredEvents.filter(event => event.Type.toLowerCase() === type);
                }

                if (subject) {
                    filteredEvents = filteredEvents.filter(event => event.Subject && event.Subject.toLowerCase().includes(subject));
                }

                if (title) { // Apply title filter
                    filteredEvents = filteredEvents.filter(event => event.Title && event.Title.toLowerCase().includes(title));
                }

                if (date) {
                    filteredEvents = filteredEvents.filter(event => event.Date === date);
                }

                renderEvents(filteredEvents);
            };

            // Add event listeners for filters
            eventTypeFilter.addEventListener('change', applyFilters);
            eventSubjectFilter.addEventListener('input', applyFilters);
            eventTitleFilter.addEventListener('input', applyFilters); // New event listener for title filter
            eventDateFilter.addEventListener('change', applyFilters);

            // Add event listeners for view switcher buttons
            showTimetableBtn.addEventListener('click', () => showSection('timetable-section'));
            showEventsBtn.addEventListener('click', () => showSection('events-section'));

            // Event listener for showing class details popup using event delegation
            timetableGrid.addEventListener('click', (event) => {
                const classCell = event.target.closest('.table-class-cell');
                if (classCell) {
                    popupSubject.textContent = classCell.dataset.subject;
                    popupTeacher.textContent = classCell.dataset.teacher;
                    popupRoom.textContent = classCell.dataset.room;
                    popupTime.textContent = `${classCell.dataset.startTime} - ${classCell.dataset.endTime}`;

                    // Display Effective Until Date if available
                    if (classCell.dataset.effectiveUntilDate && classCell.dataset.effectiveUntilDate !== 'N/A') {
                        const formattedEffectiveDate = new Date(classCell.dataset.effectiveUntilDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                        popupEffectiveUntil.textContent = `Effective Until: ${formattedEffectiveDate}`;
                        popupEffectiveUntil.style.display = 'block';
                    } else {
                        popupEffectiveUntil.textContent = '';
                        popupEffectiveUntil.style.display = 'none';
                    }

                    classDetailsPopupOverlay.classList.add('show');
                }
            });

            // Event listener for closing class details popup
            popupCloseBtn.addEventListener('click', () => {
                classDetailsPopupOverlay.classList.remove('show');
            });

            // Close popup when clicking outside it
            classDetailsPopupOverlay.addEventListener('click', (event) => {
                if (event.target === classDetailsPopupOverlay) {
                    classDetailsPopupOverlay.classList.remove('show');
                }
            });

            // Function to check URL fragment and scroll to element
            const checkUrlFragmentAndScroll = () => {
                const hash = window.location.hash;
                if (hash) {
                    if (hash.startsWith('#event-')) {
                        const eventId = hash.substring(7); // Remove '#event-' prefix
                        showSection('events-section'); // Ensure events section is visible
                        // Wait a moment for rendering to complete
                        setTimeout(() => {
                            const targetElement = document.getElementById(hash.substring(1)); // Get element by ID (remove #)
                            if (targetElement) {
                                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                targetElement.classList.add('highlight-card'); // Add highlight
                                setTimeout(() => {
                                    targetElement.classList.remove('highlight-card'); // Remove highlight after animation
                                }, 2000); // Match animation duration
                            }
                        }, 500); // Short delay to allow section to become visible and content to render
                    } else if (hash === '#timetable-section') {
                        showSection('timetable-section');
                        setTimeout(() => {
                            const targetElement = document.getElementById('timetable-grid'); // Scroll to the timetable grid
                            if (targetElement) {
                                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 500);
                    }
                }
            };

            // OneSignal Initialization
            window.OneSignal = window.OneSignal || [];
            OneSignal.push(function() {
                OneSignal.init({
                    appId: "50801439-7868-4cae-a262-018829ad2bc1", // Your actual OneSignal App ID
                    // Add other config here if you have it, like safari_web_id
                    autoResubscribe: true, // Recommended to automatically re-subscribe users
                    persistNotification: false, // Optional: Notifications disappear after click
                    // serviceWorkerPath: '/OneSignalSDKWorker.js' // Only if you put it in root
                });

                // Explicitly show the OneSignal slidedown prompt to encourage subscription
                OneSignal.showSlidedownPrompt();

                OneSignal.isPushNotificationsEnabled(function(isEnabled) {
                    if (isEnabled) {
                        console.log("Push notifications are enabled!");
                    } else {
                        console.log("Push notifications are NOT enabled. Prompting for subscription...");
                    }
                });
            });


            // Initial data fetch and rendering on page load
            showLoader();
            try {
                const [timetableData, eventsData] = await Promise.all([
                    fetchData('Timetable'),
                    fetchData('Events')
                ]);

                renderTimetable(timetableData);
                allEvents = eventsData;
                applyFilters();

                // Call this after initial rendering to handle deep links
                checkUrlFragmentAndScroll();

                // Default to timetable if no specific hash is present
                if (!window.location.hash) {
                    showSection('timetable-section');
                }


            } catch (error) {
                console.error("Failed to fetch initial data:", error);
                timetableGrid.innerHTML = '<p class="no-events-message">Failed to load timetable data. Please try again later.</p>';
                eventsList.innerHTML = '<p class="no-events-message">Failed to load events data. Please try again later.</p>';
            } finally {
                hideLoader();
            }
        });
        /* --- script.js content ends here --- */
    </script>
</body>
</html>
