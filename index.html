<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Timetable & Event Reminder</title>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "50801439-7868-4cae-a262-018829ad2bc1", // <-- REPLACE WITH YOUR ONESIGNAL APP ID
        });
      });
    </script>

    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --primary-accent: #0f3460;
            --secondary-accent: #e94560;
            --text-primary: #ffffff;
            --text-secondary: #a7a9be;
            --border-color: #3d4a6c;
            --border-radius: 12px;
            --font-sans: 'Inter', sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .header {
            background-color: var(--bg-card);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .header .logo { font-size: 1.5em; font-weight: 700; text-decoration: none; color: var(--text-primary); }
        .header .nav-link { color: var(--text-secondary); text-decoration: none; padding: 0.5em 1em; border-radius: var(--border-radius); transition: all 0.3s ease; }
        .header .nav-link:hover { background-color: var(--primary-accent); color: var(--text-primary); }
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 1.5rem auto;
            padding: 0 1.5rem;
            flex-grow: 1;
        }
        h1 { font-size: clamp(2rem, 5vw, 2.5rem); font-weight: 700; margin-bottom: 1.5rem; text-align: center; }
        h2 { font-size: clamp(1.5rem, 4vw, 2rem); color: var(--text-secondary); font-weight: 700; margin-bottom: 1.5rem; text-align: center; }
        .view-switcher {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            background-color: var(--primary-accent);
            border-radius: var(--border-radius);
            padding: 0.5rem;
            flex-wrap: wrap;
        }
        .view-switcher button {
            flex: 1; padding: 12px 20px; font-size: 1em; font-weight: 600;
            border: none; border-radius: 8px; cursor: pointer;
            background-color: transparent; color: var(--text-secondary); transition: all 0.3s ease;
        }
        .view-switcher button.active { background-color: var(--bg-card); color: var(--text-primary); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .content-section { display: none; }
        .content-section.visible { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- AGENDA VIEW (Version 1) --- */
        .agenda-view { display: flex; flex-direction: column; gap: 1.5rem; }
        .day-switcher {
            display: flex; overflow-x: auto; gap: 0.5rem; padding-bottom: 1rem;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .day-switcher::-webkit-scrollbar { display: none; }
        .day-switcher button {
            flex-shrink: 0; padding: 10px 20px; font-size: 1em; font-weight: 600;
            border: 1px solid var(--border-color); border-radius: 50px; cursor: pointer;
            background-color: var(--primary-accent); color: var(--text-secondary); transition: all 0.3s ease;
        }
        .day-switcher button.active { background-color: var(--secondary-accent); color: var(--text-primary); border-color: var(--secondary-accent); }
        
        .agenda-day-content { display: none; }
        .agenda-day-content.active { display: block; animation: fadeIn 0.4s; }
        
        .agenda-class-card {
            display: grid;
            grid-template-columns: 100px 1fr;
            align-items: center;
            gap: 1.5rem;
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            border-left: 5px solid var(--primary-accent);
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .agenda-class-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            border-left-color: var(--secondary-accent);
        }
        .agenda-class-card.is-current {
            border-left-color: var(--secondary-accent);
            box-shadow: 0 0 25px rgba(233, 69, 96, 0.3);
        }
        .class-time { text-align: center; }
        .class-time .start-time { font-size: 1.2em; font-weight: 700; display: block; }
        .class-time .end-time { font-size: 0.9em; color: var(--text-secondary); }
        
        .class-details h3 { font-size: 1.4em; margin: 0 0 0.25rem; color: var(--text-primary); }
        .class-details p { margin: 0; color: var(--text-secondary); font-size: 0.95em; }

        /* --- FILTERS & EVENTS (Compact & Grouped) --- */
        .filters {
            display: none;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem 1.5rem;
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        .filters.visible { display: flex; }
        .filters > div { flex: 1 1 200px; }
        .filters select, .filters input {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 0.9rem; color: var(--text-primary);
            background-color: var(--primary-accent);
        }
        
        /* --- FIX: Event group titles now span the full grid width --- */
        .event-group-title {
            grid-column: 1 / -1; /* Span across all grid columns */
            color: var(--secondary-accent);
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* --- FIX: The main events list is the grid container for the CARDS --- */
        #events-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
            gap: 1.5rem; 
        }
        .event-card { 
            background-color: var(--bg-card); 
            border-radius: var(--border-radius); 
            padding: 1.5rem; 
            border-left: 5px solid; 
            transition: all 0.3s ease; 
        }
        .event-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .event-card.assignment { border-color: #ff9800; } .event-card.exam { border-color: #f44336; } .event-card.notice { border-color: #4caf50; } .event-card.holiday { border-color: #9c27b0; }
        .event-card h4 { margin: 0.5rem 0; font-size: 1.4em; } .event-card p { margin: 4px 0; color: var(--text-secondary); }
        .event-card .time-left { font-size: 1.1em; font-weight: 700; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); text-align: right; }
        .event-card .time-left.overdue { color: #f44336; }
        .event-card .time-left.soon { color: #ff9800; }
        .event-card .time-left:not(.overdue):not(.soon) { color: var(--text-primary); }

        /* --- NEW: Highlight Animation --- */
        .highlight-card {
            animation: pulse-highlight 2.5s ease-out;
        }
        @keyframes pulse-highlight {
            0% { box-shadow: 0 0 0 0 rgba(233, 69, 96, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(233, 69, 96, 0); }
            100% { box-shadow: 0 0 0 0 rgba(233, 69, 96, 0); }
        }

        /* --- POPUP & MISC --- */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .popup-overlay.show { opacity: 1; visibility: visible; }
        .popup-content { background-color: var(--bg-card); padding: 2rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); max-width: 500px; width: 90%; }
        .popup-content .close-btn { position: absolute; top: 1rem; right: 1rem; font-size: 2rem; cursor: pointer; color: var(--text-secondary); background: none; border: none; }
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--secondary-accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 50px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader.show { display: block; }
        .no-data-message { text-align: center; padding: 3rem; font-size: 1.2em; color: var(--text-secondary); background-color: var(--primary-accent); border-radius: var(--border-radius); }
        .footer { background-color: var(--bg-card); color: var(--text-secondary); text-align: center; padding: 1.5rem; margin-top: 2rem; border-top: 1px solid var(--border-color); }
    </style>
</head>
<body>
    <header class="header">
        <a href="index.html" class="logo">Scheduler</a>
        <nav><a href="admin.html" class="nav-link">Admin Panel</a></nav>
    </header>
    <main class="container">
        <h1>Class Schedule & Reminders</h1>
        <div class="view-switcher">
            <button id="showTimetableBtn" class="active">Timetable</button>
            <button id="showEventsBtn">Events</button>
        </div>
        <div id="filters" class="filters"></div>
        <div id="loader" class="loader show"></div>
        <div id="timetable-section" class="content-section visible"></div>
        <div id="events-section" class="content-section">
            <h2>Upcoming Events</h2>
            <div id="events-list"></div>
        </div>
    </main>
    <div id="classDetailsPopupOverlay" class="popup-overlay">
        <div class="popup-content">
            <button class="close-btn">&times;</button>
            <h3 id="popupSubject"></h3>
            <p><strong>Teacher:</strong> <span id="popupTeacher"></span></p>
            <p><strong>Room:</strong> <span id="popupRoom"></span></p>
            <p><strong>Time:</strong> <span id="popupTime"></span></p>
            <p id="popupEffectiveUntil" style="font-style: italic; font-size: 0.9em;"></p>
        </div>
    </div>
    <footer class="footer">
        <p>&copy; 2025 Class Timetable & Event Reminder. All rights reserved.</p>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxGqXnD92jAI08s7BMsHxFd9UJIW8h1viUfkg0sAdFJAsHdnTyx0C59K_be-P2tU7mQtA/exec';
        const SECRET_KEY = 'your_secret_key_here';

        let allTimetable = [];
        let allEvents = [];
        let highlightInterval;
        const activeCountdowns = {};

        // --- Element Selectors ---
        const loader = document.getElementById('loader');
        const filtersContainer = document.getElementById('filters');
        const popupOverlay = document.getElementById('classDetailsPopupOverlay');
        const timetableSection = document.getElementById('timetable-section');
        const eventsSection = document.getElementById('events-section');

        // --- Utility Functions ---
        const showLoader = () => loader.classList.add('show');
        const hideLoader = () => loader.classList.remove('show');
        
        const fetchData = async (sheetName) => {
            try {
                const url = `${WEB_APP_URL}?sheet=${sheetName}&secretKey=${SECRET_KEY}&token=dummy_token_for_public_read`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${sheetName}:`, error);
                return [];
            }
        };

        const robustFormatTime = (timeValue) => {
            if (!timeValue) return 'N/A';
            try {
                let dateObj;
                if (timeValue instanceof Date) { dateObj = timeValue; }
                else if (typeof timeValue === 'string') {
                    if (timeValue.includes('T')) { dateObj = new Date(timeValue); }
                    else { const parts = timeValue.split(':'); dateObj = new Date(); dateObj.setHours(parts[0], parts[1], 0, 0); }
                } else { dateObj = new Date(timeValue); }
                if (isNaN(dateObj.getTime())) return String(timeValue);
                return dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            } catch (e) { return String(timeValue); }
        };

        const robustTimeToMinutes = (timeValue) => {
            if (!timeValue) return 0;
            try {
                let h = 0, m = 0;
                if (timeValue instanceof Date) { h = timeValue.getHours(); m = timeValue.getMinutes(); }
                else if (typeof timeValue === 'string') {
                    if (timeValue.includes('T')) { const timePart = timeValue.split('T')[1]; [h, m] = timePart.split(':').map(Number); }
                    else { [h, m] = timeValue.split(':').map(Number); }
                } else {
                    const dateObj = new Date(timeValue);
                    if (!isNaN(dateObj.getTime())) { h = dateObj.getHours(); m = dateObj.getMinutes(); }
                }
                return (h * 60) + m;
            } catch { return 0; }
        };

        // --- Core Logic ---
        const showSection = (sectionId) => {
            document.querySelectorAll('.content-section').forEach(s => s.classList.toggle('visible', s.id === sectionId));
            filtersContainer.classList.toggle('visible', sectionId === 'events-section');
            document.querySelectorAll('.view-switcher button').forEach(b => b.classList.toggle('active', b.id.includes(sectionId.split('-')[0])));
            if (sectionId === 'timetable-section') {
                highlightCurrentClass();
            } else {
                if (highlightInterval) clearInterval(highlightInterval);
            }
        };

        // --- Timetable Rendering (AGENDA VIEW) ---
        const renderTimetable = (data) => {
            const container = document.getElementById('timetable-section');
            if (data.length === 0) {
                container.innerHTML = '<p class="no-data-message">No timetable data available.</p>';
                return;
            }
            container.innerHTML = `<h2>Daily Agenda</h2><div class="agenda-view"></div>`;
            renderAgendaView(data);
        };

        const renderAgendaView = (data) => {
            const container = document.querySelector('.agenda-view');
            const dayOrder = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            const classesByDay = dayOrder.reduce((acc, day) => ({...acc, [day]: []}), {});
            data.forEach(item => { if (item.Day && classesByDay[item.Day]) classesByDay[item.Day].push(item); });

            const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            const activeDay = dayOrder.includes(today) ? today : "Monday";

            let agendaHtml = `<div class="day-switcher">${dayOrder.map(d => `<button data-day="${d}" class="${d === activeDay ? 'active' : ''}">${d}</button>`).join('')}</div>`;
            
            dayOrder.forEach(day => {
                const dayClasses = classesByDay[day].sort((a, b) => robustTimeToMinutes(a.StartTime) - robustTimeToMinutes(b.StartTime));
                agendaHtml += `<div class="agenda-day-content ${day === activeDay ? 'active' : ''}" id="agenda-${day}">`;
                if (dayClasses.length > 0) {
                    dayClasses.forEach(c => {
                        agendaHtml += `
                            <div class="agenda-class-card" data-id="${c.ID}" data-start="${c.StartTime}" data-end="${c.EndTime}">
                                <div class="class-time">
                                    <span class="start-time">${robustFormatTime(c.StartTime)}</span>
                                    <span class="end-time">${robustFormatTime(c.EndTime)}</span>
                                </div>
                                <div class="class-details">
                                    <h3>${c.Subject}</h3>
                                    <p>${c.Teacher} &bull; Room ${c.Room}</p>
                                </div>
                            </div>`;
                    });
                } else {
                    agendaHtml += '<p class="no-data-message">No classes scheduled for this day.</p>';
                }
                agendaHtml += `</div>`;
            });
            container.innerHTML = agendaHtml;
            highlightCurrentClass();
        };

        const highlightCurrentClass = () => {
            if (highlightInterval) clearInterval(highlightInterval);
            const updateHighlight = () => {
                const todayName = new Date().toLocaleDateString('en-US', { weekday: 'long' });
                const activeDayContainer = document.getElementById(`agenda-${todayName}`);
                if (!activeDayContainer) return;

                document.querySelectorAll('.agenda-class-card.is-current').forEach(el => el.classList.remove('is-current'));
                
                const nowInMinutes = new Date().getHours() * 60 + new Date().getMinutes();
                const classCards = activeDayContainer.querySelectorAll('.agenda-class-card');
                
                for (const card of classCards) {
                    const start = robustTimeToMinutes(card.dataset.start);
                    const end = robustTimeToMinutes(card.dataset.end);
                    if (nowInMinutes >= start && nowInMinutes < end) {
                        card.classList.add('is-current');
                        break;
                    }
                }
            };
            updateHighlight();
            highlightInterval = setInterval(updateHighlight, 60000);
        };

        // --- Events Rendering (IMPROVED GROUPED VIEW) ---
        const renderEvents = (events) => {
            const eventsList = document.getElementById('events-list');
            if (!eventsList) return;
            clearAllCountdowns();
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
            const endOfWeek = new Date(today); endOfWeek.setDate(today.getDate() + (7 - today.getDay()));

            const groups = { today: [], tomorrow: [], thisWeek: [], later: [] };

            events.filter(e => new Date(e.Date) >= today)
                  .sort((a, b) => new Date(a.Date) - new Date(b.Date))
                  .forEach(event => {
                      const eventDate = new Date(event.Date);
                      if (eventDate.getTime() === today.getTime()) groups.today.push(event);
                      else if (eventDate.getTime() === tomorrow.getTime()) groups.tomorrow.push(event);
                      else if (eventDate <= endOfWeek) groups.thisWeek.push(event);
                      else groups.later.push(event);
                  });

            let html = '';
            const createEventCard = event => {
                const formattedDate = new Date(event.Date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                return `<div class="event-card ${event.Type?.toLowerCase()}" id="event-${event.ID}">
                    <h4>${event.Title}</h4>
                    <p><strong>${event.Subject}</strong> &bull; ${formattedDate}</p>
                    <p>${event.Details}</p>
                    <div class="time-left" id="countdown-${event.ID}"></div>
                </div>`;
            };

            // --- FIX: Generate group titles and cards directly inside the grid container ---
            if (groups.today.length) {
                html += `<h3 class="event-group-title">Today</h3>`;
                html += groups.today.map(createEventCard).join('');
            }
            if (groups.tomorrow.length) {
                html += `<h3 class="event-group-title">Tomorrow</h3>`;
                html += groups.tomorrow.map(createEventCard).join('');
            }
            if (groups.thisWeek.length) {
                html += `<h3 class="event-group-title">This Week</h3>`;
                html += groups.thisWeek.map(createEventCard).join('');
            }
            if (groups.later.length) {
                html += `<h3 class="event-group-title">Later</h3>`;
                html += groups.later.map(createEventCard).join('');
            }
            
            if (html === '') {
                eventsList.innerHTML = '<p class="no-data-message">No upcoming events found.</p>';
            } else {
                eventsList.innerHTML = html;
                [...groups.today, ...groups.tomorrow, ...groups.thisWeek, ...groups.later].forEach(setupCountdown);
            }
        };
        
        const clearAllCountdowns = () => Object.values(activeCountdowns).forEach(clearInterval);
        const setupCountdown = (event) => {
            const el = document.getElementById(`countdown-${event.ID}`);
            if (!el) return;
            const update = () => {
                const diff = new Date(`${event.Date} ${event.Time || '00:00'}`).getTime() - new Date().getTime();
                if (diff < 0) { el.textContent = "OVERDUE"; el.className = 'time-left overdue'; clearInterval(activeCountdowns[event.ID]); return; }
                const d = Math.floor(diff / 864e5), h = Math.floor(diff % 864e5 / 36e5), m = Math.floor(diff % 36e5 / 6e4), s = Math.floor(diff % 6e4 / 1e3);
                let text = d > 0 ? `${d}d ${h}h left` : h > 0 ? `${h}h ${m}m left` : m > 0 ? `${m}m ${s}s left` : `${s}s left`;
                el.textContent = text;
                el.className = `time-left ${d < 7 ? 'soon' : ''}`;
            };
            update();
            activeCountdowns[event.ID] = setInterval(update, 1000);
        };
        
        const applyFilters = () => {
            const type = document.getElementById('eventType').value.toLowerCase();
            const subject = document.getElementById('eventSubject').value.toLowerCase().trim();
            const title = document.getElementById('eventTitleFilter').value.toLowerCase().trim();
            const date = document.getElementById('eventDate').value;
            const filtered = allEvents.filter(e => 
                (!type || e.Type?.toLowerCase() === type) &&
                (!subject || e.Subject?.toLowerCase().includes(subject)) &&
                (!title || e.Title?.toLowerCase().includes(title)) &&
                (!date || e.Date === date)
            );
            renderEvents(filtered);
        };

        const showClassPopup = (classData) => {
            popupOverlay.querySelector('#popupSubject').textContent = classData.Subject;
            popupOverlay.querySelector('#popupTeacher').textContent = classData.Teacher;
            popupOverlay.querySelector('#popupRoom').textContent = classData.Room;
            popupOverlay.querySelector('#popupTime').textContent = `${robustFormatTime(classData.StartTime)} - ${robustFormatTime(classData.EndTime)}`;
            const effectiveEl = popupOverlay.querySelector('#popupEffectiveUntil');
            if (classData.EffectiveUntilDate) {
                effectiveEl.textContent = `Effective Until: ${new Date(classData.EffectiveUntilDate).toLocaleDateString('en-GB')}`;
                effectiveEl.style.display = 'block';
            } else {
                effectiveEl.style.display = 'none';
            }
            popupOverlay.classList.add('show');
        };

        // --- FIXED: Function to handle deep linking from notifications ---
        const checkUrlFragmentAndScroll = () => {
            const hash = window.location.hash;
            if (hash.startsWith('#event-')) {
                showSection('events-section');
                setTimeout(() => {
                    const targetElement = document.getElementById(hash.substring(1));
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Add a temporary highlight effect
                        targetElement.classList.add('highlight-card');
                        setTimeout(() => {
                            targetElement.classList.remove('highlight-card');
                        }, 2500);
                    }
                }, 100); // Small delay to ensure the section is visible
            } else {
                // Default to timetable if no specific hash is present
                showSection('timetable-section');
            }
        };

        // --- Event Listeners ---
        document.getElementById('showTimetableBtn').addEventListener('click', () => showSection('timetable-section'));
        document.getElementById('showEventsBtn').addEventListener('click', () => showSection('events-section'));
        timetableSection.addEventListener('click', (e) => {
            const dayButton = e.target.closest('.day-switcher button');
            if (dayButton) {
                document.querySelector('.day-switcher button.active')?.classList.remove('active');
                dayButton.classList.add('active');
                document.querySelector('.agenda-day-content.active')?.classList.remove('active');
                document.getElementById(`agenda-${dayButton.dataset.day}`).classList.add('active');
                highlightCurrentClass();
            }
            const classCell = e.target.closest('.agenda-class-card');
            if (classCell) {
                const classData = allTimetable.find(c => c.ID == classCell.dataset.id);
                if (classData) showClassPopup(classData);
            }
        });
        popupOverlay.addEventListener('click', (e) => {
            if (e.target.matches('.popup-overlay, .close-btn')) e.currentTarget.classList.remove('show');
        });
        filtersContainer.innerHTML = `<div><select id="eventType"><option value="">All Types</option><option value="Assignment">Assignment</option><option value="Exam">Exam</option><option value="Notice">Notice</option><option value="Holiday">Holiday</option></select></div><div><input type="text" id="eventSubject" placeholder="Filter by Subject..."></div><div><input type="text" id="eventTitleFilter" placeholder="Filter by Title..."></div><div><input type="date" id="eventDate"></div>`;
        filtersContainer.addEventListener('input', applyFilters);
        
        // --- FIXED: Initial Load Logic ---
        (async () => {
            showLoader();
            try {
                [allTimetable, allEvents] = await Promise.all([fetchData('Timetable'), fetchData('Events')]);
                renderTimetable(allTimetable);
                renderEvents(allEvents);
                // The check function now handles which section to show on load
                checkUrlFragmentAndScroll();
            } catch (error) {
                console.error("Failed during initial data processing:", error);
                timetableSection.innerHTML = '<p class="no-data-message">Failed to load data. Check console for details.</p>';
                eventsSection.innerHTML = '<p class="no-data-message">Failed to load data. Check console for details.</p>';
            } finally {
                hideLoader();
            }
        })();
    });
    </script>
</body>
</html>
