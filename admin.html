<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Timetable & Events</title>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --primary-accent: #0f3460;
            --secondary-accent: #e94560;
            --text-primary: #ffffff;
            --text-secondary: #a7a9be;
            --border-color: #3d4a6c;
            --success-color: #28a745;
            --error-color: #e74c3c;
            --border-radius: 12px;
            --font-sans: 'Inter', sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .header {
            background-color: var(--bg-card);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .header .logo { font-size: 1.5em; font-weight: 700; text-decoration: none; color: var(--text-primary); }
        .header .nav-link { color: var(--text-secondary); text-decoration: none; padding: 0.5em 1em; border-radius: var(--border-radius); transition: all 0.3s ease; }
        .header .nav-link:hover { background-color: var(--primary-accent); color: var(--text-primary); }
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 1.5rem auto;
            padding: 0 1.5rem;
            flex-grow: 1;
        }
        h1, h2 { font-weight: 700; margin-bottom: 1.5rem; text-align: center; }
        h1 { font-size: clamp(2rem, 5vw, 2.5rem); }
        h2 { font-size: clamp(1.5rem, 4vw, 2rem); color: var(--text-secondary); }
        
        #loginSection .admin-form { max-width: 450px; margin: 2rem auto; padding: 2.5rem; background-color: var(--bg-card); border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        #signOutBtn { padding: 10px 20px; background-color: var(--secondary-accent); color: white; border: none; border-radius: var(--border-radius); font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        #signOutBtn:hover { background-color: #c73049; transform: translateY(-2px); }
        .admin-view-switcher { display: flex; justify-content: center; margin-bottom: 2rem; background-color: var(--primary-accent); border-radius: var(--border-radius); padding: 0.5rem; flex-wrap: wrap; }
        .admin-view-switcher button { flex: 1; padding: 12px 20px; font-size: 1em; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; background-color: transparent; color: var(--text-secondary); transition: all 0.3s ease; }
        .admin-view-switcher button.active { background-color: var(--bg-card); color: var(--text-primary); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .form-section { display: none; }
        .form-section.visible { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .admin-form { display: grid; grid-template-columns: 1fr; gap: 1.5rem; max-width: 700px; margin: 0 auto; padding: 2rem; background-color: var(--bg-card); border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .admin-form label { font-weight: 500; color: var(--text-secondary); }
        .admin-form input, .admin-form select, .admin-form textarea { padding: 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; font-family: var(--font-sans); color: var(--text-primary); background-color: var(--primary-accent); width: 100%; }
        .admin-form input:focus, .admin-form select:focus, .admin-form textarea:focus { outline: none; border-color: var(--secondary-accent); box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2); }
        .admin-form button[type="submit"] { padding: 14px 25px; background-color: var(--success-color); color: white; border: none; border-radius: var(--border-radius); font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.3s ease; grid-column: 1 / -1; }
        .admin-form button[type="submit"]:hover { background-color: #218838; transform: translateY(-2px); }
        .admin-form button[type="submit"]:disabled { background-color: var(--border-color); cursor: not-allowed; transform: none; }

        /* --- Manage Section --- */
        .admin-filters { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-bottom: 1.5rem; padding: 1rem; background-color: var(--primary-accent); border-radius: var(--border-radius); }
        .admin-filters > * { flex: 1 1 200px; }
        .admin-filters select, .admin-filters input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem; color: var(--text-primary); background-color: var(--bg-card); }
        
        #admin-events-list-container, #admin-timetable-list-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
        .admin-card { background-color: var(--bg-card); border-radius: var(--border-radius); padding: 1.5rem; border-left: 5px solid var(--primary-accent); transition: all 0.3s ease; display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: center; }
        .admin-card h3 { margin: 0 0 5px; font-size: 1.2em; } .admin-card p { margin: 4px 0; color: var(--text-secondary); font-size: 0.95em; }
        .admin-card .actions { display: flex; gap: 10px; }
        
        /* General Action Button Styles */
        .actions button { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.3s ease; }
        .actions .edit-btn { background-color: var(--primary-accent); color: var(--text-primary); }
        .actions .delete-btn { background-color: var(--secondary-accent); color: var(--text-primary); }
        .actions .secondary-btn { background-color: var(--border-color); color: var(--text-primary); }


        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-card); padding: 2rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s ease; position: relative; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-content h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .modal-content .close-btn { position: absolute; top: 1rem; right: 1rem; font-size: 2rem; cursor: pointer; color: var(--text-secondary); background: none; border: none; transition: all 0.2s ease; line-height: 1; padding: 0; }
        .modal-content .close-btn:hover { color: var(--text-primary); transform: rotate(90deg); }
        .modal-content form button { background-color: var(--secondary-accent); }
        
        .message { margin-top: 1rem; padding: 12px; border-radius: var(--border-radius); text-align: center; font-weight: 500; display: none; }
        .message.success { background-color: var(--success-color); color: white; }
        .message.error { background-color: var(--error-color); color: white; }
        
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--secondary-accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader.show { display: block; }
        
        /* New Full Screen Overlay Loader */
        #fullScreenLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
        }
        #fullScreenLoader.show {
            display: flex;
        }
        #fullScreenLoader .loader {
            display: block; /* Always visible when parent is shown */
        }
        #fullScreenLoader p {
            font-size: 1.2em;
            font-weight: 500;
            color: var(--text-primary);
        }

        .no-data-message { text-align: center; padding: 3rem; font-size: 1.2em; color: var(--text-secondary); background-color: var(--primary-accent); border-radius: var(--border-radius); }
        
        /* New Day Switcher Styles from index.html */
        .day-switcher {
            display: flex;
            overflow-x: auto;
            gap: 0.5rem;
            padding-bottom: 1rem;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
            margin-bottom: 1.5rem;
        }
        .day-switcher::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .day-switcher button {
            flex-shrink: 0;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: 600;
            border: 1px solid var(--border-color);
            border-radius: 50px;
            cursor: pointer;
            background-color: var(--primary-accent);
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        .day-switcher button.active {
            background-color: var(--secondary-accent);
            color: var(--text-primary);
            border-color: var(--secondary-accent);
        }

        .agenda-day-content {
            display: none;
        }
        .agenda-day-content.active {
            display: block;
            animation: fadeIn 0.4s;
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="index.html" class="logo">Admin Dashboard</a>
        <nav><a href="index.html" class="nav-link">View Site</a></nav>
    </header>

    <main class="container">
        <div id="loginSection" class="form-section visible">
            <h1>Admin Login</h1>
            <form id="loginForm" class="admin-form">
                <div><label for="adminEmailOrUsername">Email or Username</label><input type="text" id="adminEmailOrUsername" name="emailOrUsername" required></div>
                <div><label for="adminPassword">Password</label><input type="password" id="adminPassword" name="password" required></div>
                <button type="submit">Login</button>
                <div id="loginMessage" class="message"></div><div id="loginLoader" class="loader"></div>
            </form>
        </div>

        <div id="adminContent" class="form-section">
            <div class="dashboard-header"><h1>Dashboard</h1><button id="signOutBtn">Sign Out</button></div>
            <div class="admin-view-switcher">
                <button data-target="eventFormSection" class="active">Add Event</button>
                <button data-target="timetableFormSection">Add Timetable</button>
                <button data-target="manageEventsSection">Manage Events</button>
                <button data-target="manageTimetableSection">Manage Timetable</button>
            </div>
            <div id="eventFormSection" class="form-section visible"></div>
            <div id="timetableFormSection" class="form-section"></div>
            <div id="manageEventsSection" class="form-section"></div>
            <div id="manageTimetableSection" class="form-section"></div>
        </div>
    </main>

    <!-- Modals -->
    <div id="editEventModalOverlay" class="modal-overlay"><div class="modal-content"><button class="close-btn">&times;</button><h3>Edit Event</h3><form id="editEventForm" class="admin-form"></form></div></div>
    <div id="editTimetableModalOverlay" class="modal-overlay"><div class="modal-content"><button class="close-btn">&times;</button><h3>Edit Timetable Entry</h3><form id="editTimetableForm" class="admin-form"></form></div></div>
    <div id="conflictModalOverlay" class="modal-overlay"></div>

    <!-- Full Screen Loader -->
    <div id="fullScreenLoader">
        <div class="loader"></div>
        <p>Processing...</p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxGqXnD92jAI08s7BMsHxFd9UJIW8h1viUfkg0sAdFJAsHdnTyx0C59K_be-P2tU7mQtA/exec';
        const SECRET_KEY = 'your_secret_key_here';

        let sessionToken = localStorage.getItem('adminSessionToken');
        let adminUsername = localStorage.getItem('adminUsername');
        let allEventsForAdmin = [];
        let allTimetableForAdmin = [];

        const loginSection = document.getElementById('loginSection');
        const adminContent = document.getElementById('adminContent');
        const loginForm = document.getElementById('loginForm');
        const signOutBtn = document.getElementById('signOutBtn');
        const viewSwitcherBtns = document.querySelectorAll('.admin-view-switcher button');
        const fullScreenLoader = document.getElementById('fullScreenLoader');

        const showMessage = (el, msg, type) => { el.textContent = msg; el.className = `message ${type}`; el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 5000); };
        
        // Updated toggleLoader to handle both inline and fullscreen loaders
        const toggleLoader = (loaderId, formEl, show) => {
            const loader = document.getElementById(loaderId);
            if (loader) {
                loader.classList.toggle('show', show);
            }
            if (formEl) {
                const btn = formEl.querySelector('button[type="submit"]');
                if (btn) btn.disabled = show;
            }
        };
        
        const robustFormatTime = (timeValue) => { if (!timeValue) return 'N/A'; try { let d = new Date(timeValue); if (isNaN(d.getTime())) { const p = timeValue.split(':'); d = new Date(); d.setHours(p[0], p[1], 0, 0); } return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }); } catch (e) { return String(timeValue); } };

        const showSection = async (targetId) => {
            document.querySelectorAll('#adminContent .form-section').forEach(s => s.classList.remove('visible'));
            viewSwitcherBtns.forEach(btn => btn.classList.remove('active'));
            
            const targetSection = document.getElementById(targetId);
            if (targetSection) targetSection.classList.add('visible');

            const targetButton = document.querySelector(`.admin-view-switcher button[data-target="${targetId}"]`);
            if (targetButton) targetButton.classList.add('active');

            if (targetId === 'manageEventsSection') await fetchAndRenderAdminEvents();
            if (targetId === 'manageTimetableSection') await fetchAndRenderAdminTimetable();
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            toggleLoader('loginLoader', loginForm, true);
            const msgDiv = loginForm.querySelector('.message');
            const params = new URLSearchParams({ secretKey: SECRET_KEY, action: 'login', emailOrUsername: loginForm.emailOrUsername.value, password: loginForm.password.value });
            try {
                const res = await fetch(WEB_APP_URL, { method: 'POST', body: params });
                const result = await res.json();
                if (result.status === 'success' && result.token) {
                    sessionToken = result.token; localStorage.setItem('adminSessionToken', sessionToken);
                    adminUsername = result.username; localStorage.setItem('adminUsername', adminUsername);
                    showAdminContent();
                } else { showMessage(msgDiv, result.message || 'Login failed', 'error'); }
            } catch (err) { showMessage(msgDiv, 'An error occurred during login.', 'error'); }
            finally { toggleLoader('loginLoader', loginForm, false); }
        };

        const handleLogout = () => { localStorage.removeItem('adminSessionToken'); localStorage.removeItem('adminUsername'); sessionToken = null; adminUsername = null; showLoginForm(); };
        const showAdminContent = () => { loginSection.classList.remove('visible'); adminContent.classList.add('visible'); showSection('eventFormSection'); };
        const showLoginForm = () => { loginSection.classList.add('visible'); adminContent.classList.remove('visible'); };
        
        const verifySession = async () => {
            if (!sessionToken) { showLoginForm(); return; }
            toggleLoader('loginLoader', null, true);
            const params = new URLSearchParams({ secretKey: SECRET_KEY, action: 'checkAuth', token: sessionToken });
            try {
                const res = await fetch(WEB_APP_URL, { method: 'POST', body: params });
                const result = await res.json();
                if (result.status === 'success' && result.authenticated) { showAdminContent(); }
                else { handleLogout(); }
            } catch (error) { console.error('Session verification failed:', error); handleLogout(); }
            finally { toggleLoader('loginLoader', null, false); }
        };

        const handleFormSubmit = async (e, sheetName, action, additionalData = {}) => {
            e.preventDefault();
            const form = e.target;
            const msgDiv = form.querySelector('.message');
            toggleLoader('fullScreenLoader', form, true); // Use fullscreen loader
            
            const formData = new FormData(form);
            const params = new URLSearchParams({ secretKey: SECRET_KEY, token: sessionToken, sheet: sheetName, action, ...additionalData });
            for (let [key, value] of formData.entries()) { params.append(key, value); }
            
            try {
                const res = await fetch(WEB_APP_URL, { method: 'POST', body: params });
                const result = await res.json();
                if (result.status === 'success') {
                    showMessage(msgDiv, result.message, 'success');
                    if (action.startsWith('add') || action.startsWith('replace')) form.reset();
                    const modal = form.closest('.modal-overlay');
                    if (modal) modal.classList.remove('show');
                    if (sheetName === 'Events') await fetchAndRenderAdminEvents();
                    if (sheetName === 'Timetable') await fetchAndRenderAdminTimetable();
                } else if (result.status === 'conflict') {
                    showConflictModal(result.existingEntry, formData);
                } else { showMessage(msgDiv, `Error: ${result.message}`, 'error'); }
            } catch (err) { showMessage(msgDiv, `Failed to submit: ${err.message}`, 'error'); }
            finally { toggleLoader('fullScreenLoader', form, false); }
        };

        const showConflictModal = (existingEntry, newFormData) => {
            const modal = document.getElementById('conflictModalOverlay');
            modal.innerHTML = `<div class="modal-content">
                <button class="close-btn">&times;</button>
                <h3>Schedule Conflict</h3>
                <p>This time slot is already taken by:</p>
                <div class="admin-card" style="margin-bottom: 1.5rem; grid-template-columns: 1fr;">
                    <div>
                        <h3>${existingEntry.Subject}</h3>
                        <p>${robustFormatTime(existingEntry.StartTime)} - ${robustFormatTime(existingEntry.EndTime)}</p>
                        <p><strong>Teacher:</strong> ${existingEntry.Teacher || 'N/A'}</p>
                        <p><strong>Room:</strong> ${existingEntry.Room || 'N/A'}</p>
                        <p><strong>Last Modified By:</strong> ${existingEntry.LastModifiedBy || 'N/A'}</p>
                    </div>
                </div>
                <p>Do you want to replace it with your new entry?</p>
                <div class="actions" style="justify-content: flex-end; display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button id="cancelReplace" class="secondary-btn">Cancel</button>
                    <button id="confirmReplace" class="delete-btn">Replace</button>
                </div>
            </div>`;
            modal.classList.add('show');

            document.getElementById('confirmReplace').onclick = () => {
                modal.classList.remove('show'); // Close modal immediately
                const form = document.getElementById('timetableFormSection').querySelector('form');
                const msgDiv = form.querySelector('.message');
                toggleLoader('fullScreenLoader', form, true);
                
                const params = new URLSearchParams({ secretKey: SECRET_KEY, token: sessionToken, sheet: 'Timetable', action: 'replaceTimetable', existingId: existingEntry.ID });
                for (let [key, value] of newFormData.entries()) { params.append(key, value); }
                
                fetch(WEB_APP_URL, { method: 'POST', body: params })
                    .then(res => res.json())
                    .then(result => {
                        if (result.status === 'success') {
                            showMessage(msgDiv, 'Timetable entry replaced successfully.', 'success');
                            form.reset();
                            fetchAndRenderAdminTimetable();
                        } else { showMessage(msgDiv, `Error: ${result.message}`, 'error'); }
                    })
                    .catch(err => showMessage(msgDiv, `Failed to replace: ${err.message}`, 'error'))
                    .finally(() => { toggleLoader('fullScreenLoader', form, false); });
            };
            document.getElementById('cancelReplace').onclick = () => modal.classList.remove('show');
        };

        const handleDelete = async (sheetName, id) => {
            if (!confirm(`Are you sure you want to delete this ${sheetName.slice(0, -1)}?`)) return;
            toggleLoader('fullScreenLoader', null, true);
            const params = new URLSearchParams({ secretKey: SECRET_KEY, token: sessionToken, sheet: sheetName, action: 'delete', ID: id });
            try {
                const res = await fetch(WEB_APP_URL, { method: 'POST', body: params });
                const result = await res.json();
                if (result.status === 'success') {
                    if (sheetName === 'Events') await fetchAndRenderAdminEvents();
                    if (sheetName === 'Timetable') await fetchAndRenderAdminTimetable();
                } else { alert(`Error: ${result.message}`); }
            } catch (err) { alert(`Failed to delete: ${err.message}`); }
            finally { toggleLoader('fullScreenLoader', null, false); }
        };

        const openEditModal = (overlayId, formId, data, handler) => {
            const overlay = document.getElementById(overlayId);
            const form = document.getElementById(formId);
            for (const key in data) { if (form.elements[key]) form.elements[key].value = data[key] || ''; }
            form.onsubmit = (e) => handler(e, { ID: data.ID });
            overlay.classList.add('show');
        };

        const renderAdminList = (container, items, cardRenderer) => {
            if (!items || items.length === 0) {
                container.innerHTML = '<p class="no-data-message">No data found.</p>';
            } else {
                container.innerHTML = items.map(cardRenderer).join('');
            }
        };

        const applyAdminEventFilters = () => {
            const type = document.getElementById('adminEventTypeFilter').value.toLowerCase();
            const subject = document.getElementById('adminEventSubjectFilter').value.toLowerCase().trim();
            const title = document.getElementById('adminEventTitleFilter').value.toLowerCase().trim();
            const date = document.getElementById('adminEventDateFilter').value;
            const filtered = allEventsForAdmin.filter(event => 
                (!type || event.Type?.toLowerCase() === type) &&
                (!subject || event.Subject?.toLowerCase().includes(subject)) &&
                (!title || event.Title?.toLowerCase().includes(title)) &&
                (!date || event.Date === date)
            );
            renderGroupedEvents(filtered);
        };

        const fetchAndRenderAdminEvents = async () => {
            const container = document.getElementById('manageEventsSection');
            container.innerHTML = `<h2>Manage Events</h2>
                <div class="admin-filters">
                    <select id="adminEventTypeFilter"><option value="">All Types</option><option value="Assignment">Assignment</option><option value="Exam">Exam</option><option value="Notice">Notice</option><option value="Holiday">Holiday</option></select>
                    <input type="text" id="adminEventSubjectFilter" placeholder="Filter by Subject...">
                    <input type="text" id="adminEventTitleFilter" placeholder="Filter by Title...">
                    <input type="date" id="adminEventDateFilter">
                </div>
                <div id="admin-events-list-container"><div class="loader show"></div></div>`;
            container.querySelector('.admin-filters').addEventListener('input', applyAdminEventFilters);
            try {
                const res = await fetch(`${WEB_APP_URL}?sheet=Events&secretKey=${SECRET_KEY}&token=${sessionToken}`);
                allEventsForAdmin = await res.json();
                renderGroupedEvents(allEventsForAdmin);
            } catch { container.querySelector('#admin-events-list-container').innerHTML = '<p class="no-data-message">Failed to load events.</p>'; }
        };
        
        const renderGroupedEvents = (events) => {
            const listContainer = document.getElementById('admin-events-list-container');
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const groups = { today: [], tomorrow: [], thisWeek: [], later: [], past: [] };
            events.sort((a, b) => new Date(b.Date) - new Date(a.Date))
                  .forEach(event => {
                      const eventDate = new Date(event.Date);
                      if (eventDate < today) groups.past.push(event);
                      else if (eventDate.getTime() === today.getTime()) groups.today.push(event);
                      else { groups.later.push(event); }
                  });
            
            let html = '';
            const createEventCard = event => `<div class="admin-card"><div><h3>${event.Title}</h3><p><strong>Type:</strong> ${event.Type}</p><p><strong>Date:</strong> ${event.Date} at ${robustFormatTime(event.Time)}</p></div><div class="actions"><button class="edit-btn" data-id="${event.ID}">Edit</button><button class="delete-btn" data-id="${event.ID}">Delete</button></div></div>`;
            
            if (groups.today.length) html += `<div class="event-group"><h3>Today</h3>${groups.today.map(createEventCard).join('')}</div>`;
            if (groups.later.length) html += `<div class="event-group"><h3>Upcoming</h3>${groups.later.map(createEventCard).join('')}</div>`;
            if (groups.past.length) html += `<div class="event-group"><h3>Past Events</h3>${groups.past.map(createEventCard).join('')}</div>`;
            
            listContainer.innerHTML = html === '' ? '<p class="no-data-message">No events found for this filter.</p>' : html;
        };

        const fetchAndRenderAdminTimetable = async () => {
            const container = document.getElementById('manageTimetableSection');
            container.innerHTML = '<h2>Manage Timetable</h2><div id="admin-timetable-list-container"><div class="loader show"></div></div>';
            try {
                const res = await fetch(`${WEB_APP_URL}?sheet=Timetable&secretKey=${SECRET_KEY}&token=${sessionToken}`);
                allTimetableForAdmin = await res.json();
                renderAgendaView(allTimetableForAdmin);
            } catch { container.innerHTML = '<h2>Manage Timetable</h2><p class="no-data-message">Failed to load timetable.</p>'; }
        };

        const renderAgendaView = (data) => {
            const container = document.getElementById('manageTimetableSection');
            const dayOrder = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            const classesByDay = dayOrder.reduce((acc, day) => ({...acc, [day]: []}), {});
            data.forEach(item => { if (item.Day && classesByDay[item.Day]) classesByDay[item.Day].push(item); });

            const today = new Date().toLocaleString('en-us', { weekday: 'long' });
            const firstDayToShow = dayOrder.includes(today) ? today : (dayOrder.find(d => classesByDay[d].length > 0) || dayOrder[0]);

            let agendaHtml = `<h2>Manage Timetable</h2><div class="day-switcher">${dayOrder.map(d => `<button data-day="${d}" class="${d === firstDayToShow ? 'active' : ''}">${d}</button>`).join('')}</div>`;
            
            dayOrder.forEach(day => {
                const dayClasses = classesByDay[day].sort((a, b) => (a.StartTime || "").localeCompare(b.StartTime));
                agendaHtml += `<div class="agenda-day-content ${day === firstDayToShow ? 'active' : ''}" id="agenda-${day}">`;
                if (dayClasses.length > 0) {
                    dayClasses.forEach(c => {
                        agendaHtml += `<div class="admin-card"><div><h3>${c.Subject}</h3><p>${robustFormatTime(c.StartTime)} - ${robustFormatTime(c.EndTime)}</p><p>${c.Teacher} &bull; Room ${c.Room}</p></div><div class="actions"><button class="edit-btn" data-id="${c.ID}">Edit</button><button class="delete-btn" data-id="${c.ID}">Delete</button></div></div>`;
                    });
                } else { agendaHtml += '<p class="no-data-message">No classes scheduled for this day.</p>'; }
                agendaHtml += `</div>`;
            });
            container.innerHTML = agendaHtml;
        };

        // --- Event Listeners ---
        viewSwitcherBtns.forEach(btn => btn.addEventListener('click', () => showSection(btn.dataset.target)));
        loginForm.addEventListener('submit', handleLogin);
        signOutBtn.addEventListener('click', handleLogout);
        document.addEventListener('click', (e) => {
            if (e.target.matches('.modal-overlay, .close-btn')) e.target.closest('.modal-overlay').classList.remove('show');
            if (e.target.matches('#manageEventsSection .edit-btn')) {
                const item = allEventsForAdmin.find(i => i.ID == e.target.dataset.id);
                if (item) openEditModal('editEventModalOverlay', 'editEventForm', item, (ev, data) => handleFormSubmit(ev, 'Events', 'update', data));
            }
            if (e.target.matches('#manageTimetableSection .edit-btn')) {
                const item = allTimetableForAdmin.find(i => i.ID == e.target.dataset.id);
                if (item) openEditModal('editTimetableModalOverlay', 'editTimetableForm', item, (ev, data) => handleFormSubmit(ev, 'Timetable', 'update', data));
            }
            if (e.target.matches('#manageEventsSection .delete-btn')) handleDelete('Events', e.target.dataset.id);
            if (e.target.matches('#manageTimetableSection .delete-btn')) handleDelete('Timetable', e.target.dataset.id);
            
            // Updated day switcher logic
            if (e.target.matches('.day-switcher button')) {
                document.querySelector('.day-switcher button.active')?.classList.remove('active');
                e.target.classList.add('active');
                document.querySelector('.agenda-day-content.active')?.classList.remove('active');
                document.getElementById(`agenda-${e.target.dataset.day}`)?.classList.add('active');
            }
        });
        
        // --- Initial Load & Form Setup ---
        verifySession();
        const eventFormHTML = `<h2>Add New Event</h2><form class="admin-form"><label>Event Type</label><select name="Type" required><option value="">Select Type</option><option value="Assignment">Assignment</option><option value="Exam">Exam</option><option value="Notice">Notice</option><option value="Holiday">Holiday</option></select><label>Date</label><input type="date" name="Date" required><label>Time</label><input type="time" name="Time"><label>Subject</label><input type="text" name="Subject" required><label>Title</label><input type="text" name="Title" required><label>Details</label><textarea name="Details" rows="3"></textarea><button type="submit">Add Event</button><div class="message"></div></form>`;
        const timetableFormHTML = `<h2>Add Timetable Entry</h2><form class="admin-form"><label>Day</label><select name="Day" required><option value="">Select Day</option><option value="Monday">Monday</option><option value="Tuesday">Tuesday</option><option value="Wednesday">Wednesday</option><option value="Thursday">Thursday</option><option value="Friday">Friday</option><option value="Saturday">Saturday</option><option value="Sunday">Sunday</option></select><label>Start Time</label><input type="time" name="StartTime" required><label>End Time</label><input type="time" name="EndTime" required><label>Subject</label><input type="text" name="Subject" required><label>Teacher</label><input type="text" name="Teacher" required><label>Room</label><input type="text" name="Room" required><label>Effective Until (Optional)</label><input type="date" name="EffectiveUntilDate"><button type="submit">Add Entry</button><div class="message"></div></form>`;
        document.getElementById('eventFormSection').innerHTML = eventFormHTML; document.getElementById('eventFormSection').querySelector('form').onsubmit = (e) => handleFormSubmit(e, 'Events', 'add');
        document.getElementById('timetableFormSection').innerHTML = timetableFormHTML; document.getElementById('timetableFormSection').querySelector('form').onsubmit = (e) => handleFormSubmit(e, 'Timetable', 'addTimetable');
        document.getElementById('editEventForm').innerHTML = eventFormHTML.replace('<h2>Add New Event</h2>', '').replace('Add Event', 'Save Changes');
        document.getElementById('editTimetableForm').innerHTML = timetableFormHTML.replace('<h2>Add Timetable Entry</h2>', '').replace('Add Entry', 'Save Changes');
    });
    </script>
</body>
</html>
